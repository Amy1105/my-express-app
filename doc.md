# é¡¹ç›®æ„å»º

## init 
```bash

# 1. åˆ›å»ºä¸€ä¸ªä½ çš„é¡¹ç›®ç›®å½•å¹¶è¿›å…¥
mkdir my-express-app
cd my-express-app

# 2. åˆå§‹åŒ–é¡¹ç›®ï¼Œä¼šç”Ÿæˆä¸€ä¸ª package.json æ–‡ä»¶
npm init -y

```

## å®‰è£…express

```bash
# å®‰è£… Express å¹¶å°†å…¶ä¿å­˜åˆ° package.json çš„ dependencies ä¸­
npm install express

```

## ç¼–å†™æœ€å°åŒ– Express åº”ç”¨ä»£ç 

``` javascript
// 1. å¯¼å…¥ express æ¨¡å—
const express = require('express');

// 2. åˆ›å»ºä¸€ä¸ª Express åº”ç”¨å®ä¾‹
const app = express();

// 3. å®šä¹‰ç«¯å£å·
const port = 3000;

// 4. å®šä¹‰ä¸€ä¸ªæœ€ç®€å•çš„è·¯ç”±
// å½“ç”¨æˆ·ä»¥ GET æ–¹å¼è®¿é—®æ ¹è·¯å¾„ '/' æ—¶ï¼Œæ‰§è¡Œåé¢çš„å›è°ƒå‡½æ•°
app.get('/', (req, res) => {
  res.send('Hello World from Express!');
});

// 5. å¯åŠ¨æœåŠ¡å™¨ï¼Œç›‘å¬æŒ‡å®šç«¯å£
app.listen(port, () => {
  console.log(`Express server running at http://localhost:${port}`);
});

```

## åº”ç”¨ç¨‹åºç”Ÿæˆå™¨  åœ¨Node.js 8.2.0ä»¥ä¸Šå¯ç”¨
``` bash

npx express-generator

```

## è·¯ç”±

## ä¸­é—´ä»¶

## å„ç§ä¸­é—´ä»¶ 


### è®¤è¯ä¸­é—´ä»¶

åœ¨ Express æ¡†æ¶ä¸­å®ç°ç”¨æˆ·åå’Œå¯†ç è®¤è¯ï¼Œä¸»è¦æœ‰å‡ ç§æ–¹å¼ï¼Œä»ç®€å•çš„åŸºæœ¬è®¤è¯åˆ°æ›´å®‰å…¨çš„ç°ä»£åŒ–æ–¹æ¡ˆã€‚
ä¸‹é¢è¿™ä¸ªè¡¨æ ¼æ±‡æ€»äº†å¸¸è§çš„é€‰æ‹©å’Œç‰¹ç‚¹ï¼š

| è®¤è¯æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| :--- | :--- | :--- | :--- |
| **åŸºæœ¬è®¤è¯ (Basic Auth)** | å†…éƒ¨å·¥å…·ã€ç®€å•çš„ API æµ‹è¯• | é…ç½®ç®€å•ï¼Œæ˜“äºç†è§£å’Œå®ç° | **å®‰å…¨æ€§å¾ˆä½**ï¼Œå¯†ç ä»¥Base64ç¼–ç ï¼ˆæ˜“è§£ç ï¼‰æ˜æ–‡ä¼ è¾“ï¼Œå¿…é¡»é…åˆHTTPS |
| **Passport.js æœ¬åœ°ç­–ç•¥** | æˆç†Ÿçš„Webåº”ç”¨ï¼Œéœ€è¦ç¨³å®šã€çµæ´»çš„èº«ä»½éªŒè¯ | ç”Ÿæ€ä¸°å¯Œï¼Œæ”¯æŒå¤šç§è®¤è¯ç­–ç•¥ï¼ˆå¦‚OAuthã€OpenID Connectï¼‰ï¼Œç¤¾åŒºæˆç†Ÿ | é…ç½®ç›¸å¯¹å¤æ‚ï¼Œå­¦ä¹ æ›²çº¿ç¨é™¡ |
| **express-openid-connect** | éœ€è¦é›†æˆä¼ä¸šçº§å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰æˆ–ç¬¬ä¸‰æ–¹èº«ä»½æä¾›å•†ï¼ˆå¦‚Auth0ï¼‰çš„åº”ç”¨ | éµå¾ªOpenID Connectæ ‡å‡†ï¼Œç®€åŒ–äº†ä¸ä¸“ä¸šè®¤è¯æœåŠ¡çš„é›†æˆ | ä¾èµ–å¤–éƒ¨çš„èº«ä»½æä¾›å•†ï¼Œæ¦‚å¿µè¾ƒå¤š |

ä¸‹é¢æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹**åŸºæœ¬è®¤è¯ (Basic Auth)** å’Œ **Passport.js æœ¬åœ°ç­–ç•¥**çš„å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚

### ğŸ” åŸºæœ¬è®¤è¯ (Basic Auth)

`express-basic-auth` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ä¸­é—´ä»¶ï¼Œé€‚ç”¨äºè¦æ±‚ä¸é«˜çš„å†…éƒ¨åœºæ™¯ã€‚

é¦–å…ˆï¼Œå®‰è£…ä¸­é—´ä»¶ï¼š
```bash
npm install express-basic-auth
```

**è§app-auth**

### ğŸ”‘ Passport.js ä¸æœ¬åœ°ç­–ç•¥

å¯¹äºæ­£å¼çš„ Web åº”ç”¨ï¼Œ**Passport.js** æ˜¯æ›´å¼ºå¤§å’Œå®‰å…¨çš„é€‰æ‹©ã€‚å®ƒé€šè¿‡â€œç­–ç•¥â€æ¥æ”¯æŒå„ç§è®¤è¯æ–¹å¼ï¼Œå…¶ä¸­ `passport-local` ç­–ç•¥ä¸“é—¨å¤„ç†ç”¨æˆ·åå’Œå¯†ç è®¤è¯ã€‚

**å®‰è£…å¿…è¦çš„åŒ…ï¼š**
```bash
npm install passport passport-local
```

**åŸºç¡€é…ç½®ç¤ºä¾‹ï¼š**
```javascript
const express = require('express');
const session = require('express-session'); // Passport é€šå¸¸éœ€è¦ä¼šè¯æ”¯æŒ
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

const app = express();

// ä¸­é—´ä»¶è®¾ç½®
app.use(express.urlencoded({ extended: false })); // ç”¨äºè§£æç™»å½•è¡¨å•æäº¤çš„æ•°æ®
app.use(session({ secret: 'your-secret-key', resave: false, saveUninitialized: false }));
app.use(passport.initialize());
app.use(passport.session());

// é…ç½® Passport æœ¬åœ°ç­–ç•¥
passport.use(new LocalStrategy(
    function(username, password, done) {
        // 1. æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·ï¼ˆè¿™é‡Œæ›¿æ¢ä¸ºä½ çš„æ•°æ®åº“æŸ¥è¯¢ï¼‰
        User.findOne({ username: username }, function (err, user) {
            if (err) { return done(err); }
            // 2. ç”¨æˆ·ä¸å­˜åœ¨
            if (!user) {
                return done(null, false, { message: 'ç”¨æˆ·åä¸æ­£ç¡®ã€‚' });
            }
            // 3. å¯†ç ä¸åŒ¹é…ï¼ˆè¿™é‡Œåº”ä½¿ç”¨bcryptç­‰åº“è¿›è¡Œå“ˆå¸Œæ¯”å¯¹ï¼‰
            if (!validPassword(user, password)) { // æ›¿æ¢ä¸ºä½ çš„å¯†ç éªŒè¯é€»è¾‘
                return done(null, false, { message: 'å¯†ç ä¸æ­£ç¡®ã€‚' });
            }
            // 4. è®¤è¯æˆåŠŸï¼Œè¿”å›ç”¨æˆ·å¯¹è±¡
            return done(null, user);
        });
    }
));

// é…ç½®åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”¨æˆ·ï¼ˆç”¨äºåœ¨ä¼šè¯ä¸­å­˜å‚¨å’Œè¯»å–ç”¨æˆ·ä¿¡æ¯ï¼‰
passport.serializeUser(function(user, done) {
    done(null, user.id);
});

passport.deserializeUser(function(id, done) {
    User.findById(id, function (err, user) {
        done(err, user);
    });
});

// å®šä¹‰è·¯ç”±
// ç™»å½•é¡µé¢
app.get('/login', (req, res) => {
    res.send(`
        <form action="/login" method="post">
            <div>
                <label>ç”¨æˆ·å:</label>
                <input type="text" name="username"/>
            </div>
            <div>
                <label>å¯†ç :</label>
                <input type="password" name="password"/>
            </div>
            <div>
                <input type="submit" value="ç™»å½•"/>
            </div>
        </form>
    `);
});

// å¤„ç†ç™»å½•è¯·æ±‚
app.post('/login', 
    passport.authenticate('local', { 
        successRedirect: '/dashboard', // ç™»å½•æˆåŠŸè·³è½¬
        failureRedirect: '/login',     // ç™»å½•å¤±è´¥è·³è½¬
        // failureFlash: true // å¯é€‰ï¼Œé…åˆconnect-flashæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    })
);

// å—ä¿æŠ¤çš„ä»ªè¡¨æ¿é¡µé¢
app.get('/dashboard', (req, res) => {
    // ä½¿ç”¨ `req.isAuthenticated()` æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if (!req.isAuthenticated()) {
        return res.redirect('/login');
    }
    res.send(`æ¬¢è¿å›æ¥ï¼Œ${req.user.username}ï¼<a href="/logout">é€€å‡º</a>`);
});

// é€€å‡ºç™»å½•
app.get('/logout', (req, res) => {
    req.logout(function(err) {
        if (err) { return next(err); }
        res.redirect('/');
    });
});

app.listen(3000);
```

### âš ï¸ é‡è¦å®‰å…¨æé†’

æ— è®ºé€‰æ‹©å“ªç§æ–¹å¼ï¼Œä»¥ä¸‹å‡ ç‚¹éƒ½è‡³å…³é‡è¦ï¼š

1.  **æ°¸è¿œä½¿ç”¨ HTTPS**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç¡®ä¿ä½ çš„ç½‘ç«™ä½¿ç”¨ HTTPSï¼Œç‰¹åˆ«æ˜¯å¯¹äºåŸºæœ¬è®¤è¯ï¼Œä»¥é˜²æ­¢å¯†ç åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«çªƒå¬ã€‚
2.  **å®‰å…¨åœ°å­˜å‚¨å¯†ç **ï¼š**ç»å¯¹ä¸è¦**åœ¨æ•°æ®åº“ä¸­ä»¥æ˜æ–‡å­˜å‚¨å¯†ç ã€‚åº”ä½¿ç”¨ **bcrypt** è¿™æ ·çš„ä¸“ä¸šå¯†ç å“ˆå¸Œç®—æ³•ï¼Œå¯¹å¯†ç è¿›è¡ŒåŠ ç›å“ˆå¸Œå¤„ç†ã€‚
3.  **ä¼šè¯å®‰å…¨**ï¼šä½¿ç”¨ Passport.js æ—¶ï¼Œç¡®ä¿ä¼šè¯å¯†é’¥ (`secret`) æ˜¯å¼ºå¤§ä¸”ä¿å¯†çš„ã€‚

### ğŸ’ å¦‚ä½•é€‰æ‹©

-   å¦‚æœä½ çš„éœ€æ±‚åªæ˜¯ä¸€ä¸ª**æå…¶ç®€å•ã€å†…éƒ¨ä½¿ç”¨ã€æ— éœ€è€ƒè™‘å¤æ‚å®‰å…¨æ€§çš„å·¥å…·**ï¼Œå¯ä»¥å°è¯• `express-basic-auth`ï¼ˆåŠ¡å¿…æ­é…HTTPSï¼‰ã€‚
-   å¦‚æœä½ åœ¨æ„å»ºä¸€ä¸ª**é¢å‘å…¬ä¼—çš„ã€éœ€è¦ç”¨æˆ·æ³¨å†Œç™»å½•çš„æ­£å¼ Web åº”ç”¨**ï¼Œé‚£ä¹ˆ **Passport.js é…åˆæœ¬åœ°ç­–ç•¥**æ˜¯æ›´å¯é ã€æ›´ä¸“ä¸šçš„é€‰æ‹©ã€‚

å¸Œæœ›è¿™äº›è§£é‡Šå’Œç¤ºä¾‹èƒ½å¸®åŠ©ä½ ç†è§£å¦‚ä½•åœ¨ Express ä¸­å®ç°ç”¨æˆ·åå’Œå¯†ç è®¤è¯ï¼å¦‚æœä½ å¯¹ç‰¹å®šæ­¥éª¤ï¼ˆæ¯”å¦‚ç”¨ bcrypt å“ˆå¸Œå¯†ç ï¼‰æœ‰æ›´å¤šç–‘é—®ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·±å…¥æ¢è®¨ã€‚



## ä¸­é—´ä»¶æ³¨å†Œé¡ºåº


| é¡ºåº | ä¸­é—´ä»¶ç±»å‹ | ç¤ºä¾‹/è¯´æ˜ | å…³é”®åŸå›  |
| :--- | :--- | :--- | :--- |
| **1** | **æœ€å…ˆæ³¨å†Œçš„ä¸­é—´ä»¶** | `express.json()`, `express.urlencoded()`, `cookie-parser` | åç»­ä¸­é—´ä»¶å¯èƒ½éœ€è¦è§£æåçš„è¯·æ±‚æ•°æ®ï¼ˆå¦‚è¯·æ±‚ä½“ã€Cookieï¼‰ã€‚ |
| **2** | **é™æ€æ–‡ä»¶æœåŠ¡** | `express.static('public')` | è®©é™æ€èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€CSSï¼‰èƒ½å¿«é€Ÿè¿”å›ï¼Œé¿å…ä¸å¿…è¦çš„ä¸šåŠ¡é€»è¾‘ã€‚ |
| **3** | **è‡ªå®šä¹‰åº”ç”¨çº§ä¸­é—´ä»¶** | æ—¥å¿—è®°å½•ã€é€šç”¨æƒé™æ£€æŸ¥ | åœ¨è¿›å…¥å…·ä½“è·¯ç”±å‰æ‰§è¡Œä¸€äº›é€šç”¨æ“ä½œã€‚ |
| **4** | **è·¯ç”±æ§åˆ¶å™¨** | `app.use('/api', apiRouter)`, `app.get('/user')` | **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**åœ¨æ­¤å¤„ç†ã€‚ç¡®ä¿å®ƒä»¬èƒ½è·å¾—å‰é¢ä¸­é—´ä»¶å¤„ç†è¿‡çš„æ•°æ®ã€‚ |
| **5** | **é”™è¯¯å¤„ç†ä¸­é—´ä»¶** | `app.use((err, req, res, next) => {})` | **å¿…é¡»æ”¾åœ¨æ‰€æœ‰ä¸­é—´ä»¶ä¹‹å**ï¼Œæ‰èƒ½æ•è·åˆ°å‰é¢æ‰€æœ‰ç¯èŠ‚æŠ›å‡ºçš„é”™è¯¯ã€‚ |
| **6** | **404 å¤„ç†ä¸­é—´ä»¶** | `app.use((req, res) => { res.status(404).send('Not Found') })` | å½“è¯·æ±‚æ²¡æœ‰åŒ¹é…ä»»ä½•è·¯ç”±æ—¶ï¼Œæœ€åè§¦å‘çš„å…œåº•å¤„ç†ã€‚ |

---

### ğŸ’¡ æ ¸å¿ƒåŸåˆ™ä¸æ³¨æ„äº‹é¡¹

è¡¨æ ¼çš„é¡ºåºæ˜¯åŸºç¡€ï¼Œä½†ç†è§£å…¶èƒŒåçš„åŸåˆ™èƒ½è®©ä½ æ›´çµæ´»åœ°åº”å¯¹å¤æ‚åœºæ™¯ã€‚

1.  **é¡ºåºå°±æ˜¯ä¸€åˆ‡**ï¼šExpress ä¼šä¸¥æ ¼æŒ‰ç…§ä½ ä½¿ç”¨ `app.use()` æˆ– `app.METHOD()` æ³¨å†Œä¸­é—´ä»¶çš„**ä»£ç é¡ºåº**æ¥æ‰§è¡Œå®ƒä»¬ã€‚è¿™è¢«ç§°ä¸ºâ€œä¸­é—´ä»¶æ ˆâ€ï¼Œè¯·æ±‚ä¼šåƒæ°´æµä¸€æ ·ä¾æ¬¡ç»è¿‡æ¯ä¸ªä¸­é—´ä»¶ã€‚
2.  **`next()` å‡½æ•°æ˜¯å¼€å…³**ï¼šæ¯ä¸ªä¸­é—´ä»¶å‡½æ•°é€šè¿‡è°ƒç”¨ `next()` å°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚å¦‚æœå¿˜è®°è°ƒç”¨ `next()`ï¼Œè¯·æ±‚æµç¨‹å°±ä¼šåœ¨è¯¥ä¸­é—´ä»¶â€œå¡ä½â€ã€‚
3.  **è·¯ç”±çº§ä¸­é—´ä»¶çš„ç‰¹æ®Šæ€§**ï¼šå½“ä½ å°†ä¸­é—´ä»¶ç›´æ¥æ”¾åœ¨ç‰¹å®šè·¯ç”±ä¸­ï¼ˆå¦‚ `app.get('/path', middleware1, middleware2, handler)`ï¼‰ï¼Œè¿™äº›ä¸­é—´ä»¶åªå¯¹è¯¥è·¯ç”±ç”Ÿæ•ˆï¼Œå¹¶ä¸”å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ä½ ä¼ å…¥çš„é¡ºåºã€‚
4.  **å…³äºæ¨¡æ¿å¼•æ“ï¼ˆView Engineï¼‰**ï¼šæ¨¡æ¿å¼•æ“ï¼ˆå¦‚ `app.set('view engine', 'pug')`ï¼‰çš„è®¾ç½®**ä¸ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºæ— å…³**ã€‚å®ƒæ˜¯åœ¨ä½ è°ƒç”¨ `res.render()` æ—¶æ‰ä¼šèµ·ä½œç”¨çš„å·¥å…·ï¼Œæ‰€ä»¥é€šå¸¸å’Œ `app.set('views', './views')` ä¸€èµ·åœ¨åº”ç”¨åˆå§‹åŒ–é˜¶æ®µè®¾ç½®å³å¯ï¼Œä¸å ç”¨ä¸­é—´ä»¶é¡ºåºçš„ä½ç½®ã€‚

---

### ğŸš§ å¸¸è§çš„é¡ºåºé”™è¯¯åŠä¿®æ­£

æ¥çœ‹çœ‹ä¸¤ä¸ªå®¹æ˜“å‡ºé”™çš„åœºæ™¯ï¼Œè¿™èƒ½å¸®ä½ æ›´å¥½åœ°ç†è§£ä¸Šè¿°åŸåˆ™ã€‚

**âŒ é”™è¯¯ç¤ºä¾‹1ï¼šé™æ€æ–‡ä»¶æœåŠ¡æ”¾åœ¨è·¯ç”±ä¹‹å**
```javascript
// ä¸æ¨èçš„é¡ºåº
app.use(logger); // æ—¥å¿—ä¸­é—´ä»¶
app.get('/', (req, res) => { res.send('Home Page'); }); // è·¯ç”±
app.use(express.static('public')); // é™æ€æ–‡ä»¶æœåŠ¡æ”¾å¾—å¤ªé å
```
**é—®é¢˜**ï¼šè¯·æ±‚ `/style.css` ä¼šå…ˆè¢« `/` è·¯ç”±åŒ¹é…å—ï¼Ÿä¸ä¸€å®šï¼Œä½†æ›´ä¸¥é‡çš„æ˜¯ï¼Œé™æ€æ–‡ä»¶è¯·æ±‚å¯èƒ½æ— æ³•è¢«æ­£ç¡®å“åº”ã€‚æ­£ç¡®çš„åšæ³•æ˜¯è®©é™æ€èµ„æºå°½æ—©è¢«å¤„ç†ã€‚

**âœ… æ­£ç¡®é¡ºåº**ï¼š
```javascript
app.use(express.static('public')); // ä¼˜å…ˆå¤„ç†é™æ€èµ„æº
app.use(logger); // å†è®°å½•æ—¥å¿—ï¼ˆæ­¤æ—¶é™æ€èµ„æºçš„è¯·æ±‚ä¹Ÿä¼šè¢«è®°å½•ï¼‰
app.get('/', (req, res) => { res.send('Home Page'); });
```

**âŒ é”™è¯¯ç¤ºä¾‹2ï¼šé”™è¯¯å¤„ç†ä¸­é—´ä»¶æ”¾åœ¨è·¯ç”±ä¹‹å‰**
```javascript
// é”™è¯¯çš„é¡ºåº
app.use((err, req, res, next) => { // é”™è¯¯å¤„ç†ä¸­é—´ä»¶
  console.error(err.stack);
  res.status(500).send('Something broke!');
});
app.get('/', (req, res) => {
  throw new Error('æ¨¡æ‹Ÿä¸€ä¸ªé”™è¯¯ï¼'); // è¿™ä¸ªé”™è¯¯å°†æ— æ³•è¢«ä¸Šé¢çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ•è·
});
```
**é—®é¢˜**ï¼šé”™è¯¯å¤„ç†ä¸­é—´ä»¶æœ‰ **4 ä¸ªå‚æ•°** `(err, req, res, next)`ï¼ŒExpress é€šè¿‡å‚æ•°æ•°é‡æ¥è¯†åˆ«å®ƒã€‚å¦‚æœæŠŠå®ƒæ”¾åœ¨æ‰€æœ‰å¯èƒ½å‡ºé”™çš„è·¯ç”±**ä¹‹å‰**ï¼Œå®ƒæ ¹æœ¬æ— æ³•æ•è·åé¢å‘ç”Ÿçš„é”™è¯¯ã€‚

**âœ… æ­£ç¡®é¡ºåº**ï¼š
```javascript
app.get('/', (req, res) => {
  throw new Error('æ¨¡æ‹Ÿä¸€ä¸ªé”™è¯¯ï¼');
});
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶å¿…é¡»ä½äºæ‰€æœ‰è·¯ç”±ä¹‹å
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('Something broke!');
});
```

---

### ğŸ› ï¸ ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ç»“æ„å‚è€ƒ

ç»“åˆä»¥ä¸Šæ‰€æœ‰è¦ç‚¹ï¼Œä¸€ä¸ªç»“æ„æ¸…æ™°çš„ Express åº”ç”¨åˆå§‹åŒ–ä»£ç çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```javascript
const express = require('express');
const app = express();

// 1. è®¾ç½®æ¨¡æ¿å¼•æ“ï¼ˆä¸é¡ºåºæ— å…³ï¼Œä½†ä¸€èˆ¬æ”¾åœ¨å‰é¢ï¼‰
app.set('view engine', 'ejs');

// 2. æœ€å…ˆæ³¨å†Œï¼šè§£æè¯·æ±‚æ•°æ®çš„ä¸­é—´ä»¶
app.use(express.json()); // è§£æ application/json
app.use(express.urlencoded({ extended: true })); // è§£æ application/x-www-form-urlencoded

// 3. é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static('public'));

// 4. è‡ªå®šä¹‰åº”ç”¨çº§ä¸­é—´ä»¶ï¼ˆå¦‚æ—¥å¿—ã€è·¨åŸŸå¤„ç†ç­‰ï¼‰
app.use((req, res, next) => {
  console.log(`è¯·æ±‚æ”¶åˆ°: ${req.method} ${req.url}`);
  next(); // åŠ¡å¿…è°ƒç”¨ next()
});

// 5. è·¯ç”±ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
app.use('/api', require('./routes/api')); // API è·¯ç”±
app.use('/', require('./routes/web')); // ç½‘é¡µè·¯ç”±

// 6. 404 å¤„ç†ï¼ˆæ”¾åœ¨æ‰€æœ‰è·¯ç”±ä¹‹åï¼Œé”™è¯¯å¤„ç†ä¹‹å‰ï¼‰
app.use((req, res) => {
  res.status(404).render('404');
});

// 7. æœ€åï¼šé”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼ˆå¿…é¡»æœ‰4ä¸ªå‚æ•°ï¼‰
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼');
});

app.listen(3000);
```

å¸Œæœ›è¿™ä¸ªè¯¦ç»†çš„è§£é‡Šå’Œç¤ºä¾‹èƒ½å¸®åŠ©ä½ å½»åº•æŒæ¡ Express ä¸­é—´ä»¶çš„æ³¨å†Œé¡ºåºï¼å¦‚æœä½ åœ¨å…·ä½“å®è·µä¸­é‡åˆ°æ›´ç‰¹æ®Šçš„æƒ…å†µï¼Œéšæ—¶å¯ä»¥å†é—®æˆ‘ã€‚